package output

import (
    "fmt"
    "os"
    "path"
    "strconv"
    "hasseg.org/sanat/model"
)
    
func panicIfError(e error) {
    if e != nil {
        panic(e)
    }
}

func AppleFormatSpecifierStringForFormatSpecifier(segment model.TranslationValueSegment) string {
    ret := "%"
    if 0 < segment.SemanticOrderIndex {
        ret += strconv.Itoa(segment.SemanticOrderIndex) + "$"
    }
    if segment.DataType == model.DataTypeFloat && 0 <= segment.NumberOfDecimals {
        ret += "." + strconv.Itoa(segment.NumberOfDecimals)
    }
    switch segment.DataType {
        case model.DataTypeString: ret += "s"
        case model.DataTypeInteger: ret += "d"
        case model.DataTypeFloat: ret += "f"
        case model.DataTypeObject: ret += "@"
    }
    return ret
}

func AppleStringFromSegments(segments []model.TranslationValueSegment) string {
    ret := ""
    for _,segment := range segments {
        if segment.IsFormatSpecifier {
            ret += AppleFormatSpecifierStringForFormatSpecifier(segment)
        } else {
            ret += segment.Text
        }
    }
    return ret
}

func getAppleStringsFileContents(set model.TranslationSet, language string) string {
    ret := "/**\n" +
           " * Apple Strings File\n" +
           " * Generated by TODO\n" +
           " * Language: " + language + "\n" +
           " */"
    for _,section := range set.Sections {
        ret += "\n/********** " + section.Name + " **********/\n"
        for _,translation := range section.Translations {
            for _,value := range translation.Values {
                if value.Language == language {
                    ret += fmt.Sprintf("\"%s\" = \"%s\";\n",
                                       translation.Key,
                                       AppleStringFromSegments(value.Segments))
                }
            }
        }
    }
    return ret
}

func WriteAppleStringsFiles(set model.TranslationSet, outDirPath string) {
    for language,_ := range set.Languages {
        lprojPath := path.Join(outDirPath, language+".lproj")
        os.MkdirAll(lprojPath, 0777)

        f, err := os.Create(path.Join(lprojPath, "Localizable.strings"))
        panicIfError(err)

        _, err = f.WriteString(getAppleStringsFileContents(set, language))
        panicIfError(err)
    }
}
